<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>External Website Test - Call Tracking</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .phone { color: #007bff; font-weight: bold; font-size: 1.2em; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .debug { background: #e9ecef; padding: 15px; margin: 20px 0; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ðŸ§ª External Website Call Tracking Test</h1>
    <p>This simulates your external website in VSCode. All phone numbers should be replaced automatically.</p>
    
    <div class="test-section">
        <h2>Phone Numbers to Replace:</h2>
        <p>Call us today: <span class="phone">(555) 123-4567</span></p>
        <p>Sales department: <span class="phone">555-123-4567</span></p>
        <p>Support line: <span class="phone">555.123.4567</span></p>
        <p>Emergency: <span class="phone">+1 (555) 123-4567</span></p>
        
        <h3>Button Links:</h3>
        <a href="tel:+15551234567" class="phone">ðŸ“ž Call (555) 123-4567</a><br><br>
        <a href="tel:5551234567" class="phone">ðŸ“ž Call 555-123-4567</a><br><br>
        
        <h3>Special Classes:</h3>
        <div class="tracking-number">(555) 123-4567</div>
        <span data-tracking-number="true">555-123-4567</span>
    </div>
    
    <div class="debug">
        <strong>Debug Console:</strong><br>
        Open browser dev tools (F12) and check the Console tab to see tracking activity.
    </div>
    
    <!-- OPTION 1: Direct JavaScript Code (Recommended for external sites) -->
    <script>
    (function() {
      'use strict';
      
      // CONFIGURATION - Replace with your server URL
      var TRACKING_SERVER = 'http://localhost:5000'; // Change this to your domain
      
      // CAMPAIGN ID - Replace with your actual campaign ID
      var CAMPAIGN_ID = 'b14514dc-b985-4790-a6e1-fd2d8db5467e';
      
      // Generate unique session ID
      var sessionId = 'dni_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Capture URL parameters
      var urlParams = new URLSearchParams(window.location.search);
      var trackingData = {
        campaignId: CAMPAIGN_ID,
        sessionId: sessionId,
        domain: window.location.hostname,
        referrer: document.referrer,
        userAgent: navigator.userAgent,
        // Standard UTM parameters
        utmSource: urlParams.get('utm_source'),
        utmMedium: urlParams.get('utm_medium'),
        utmCampaign: urlParams.get('utm_campaign'),
        utmContent: urlParams.get('utm_content'),
        utmTerm: urlParams.get('utm_term'),
        // Extended tracking parameters
        publisher: urlParams.get('publisher'),
        gclid: urlParams.get('gclid'),
        fbclid: urlParams.get('fbclid')
      };
      
      // Phone number patterns to detect
      var phonePatterns = [
        /(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g,  // US format
        /(\+1[-.\s]?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/g,  // +1 format
        /(\d{3}[-.\s]?\d{3}[-.\s]?\d{4})/g  // Simple format
      ];
      
      // Function to detect and replace phone numbers
      function replacePhoneNumbers(trackingNumber, formattedNumber) {
        console.log('CallCenter Pro: Replacing phone numbers with', formattedNumber);
        
        // Find all text nodes in the document
        var walker = document.createTreeWalker(
          document.body,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        
        var textNodes = [];
        var node;
        while (node = walker.nextNode()) {
          // Skip script and style elements
          if (node.parentNode.tagName === 'SCRIPT' || node.parentNode.tagName === 'STYLE') {
            continue;
          }
          textNodes.push(node);
        }
        
        var replacedCount = 0;
        
        // Replace phone numbers in text nodes
        textNodes.forEach(function(textNode) {
          var originalText = textNode.textContent;
          var newText = originalText;
          
          phonePatterns.forEach(function(pattern) {
            if (pattern.test(newText)) {
              newText = newText.replace(pattern, formattedNumber);
              replacedCount++;
            }
          });
          
          if (newText !== originalText) {
            textNode.textContent = newText;
          }
        });
        
        // Find and update phone number links
        var phoneLinks = document.querySelectorAll('a[href^="tel:"]');
        phoneLinks.forEach(function(link) {
          link.href = 'tel:' + trackingNumber.replace(/[^\d+]/g, '');
          if (link.textContent.match(/(\d{3}[-.\s]?\d{3}[-.\s]?\d{4})/)) {
            link.textContent = formattedNumber;
            replacedCount++;
          }
        });
        
        // Find elements with tracking classes/attributes
        var trackingElements = document.querySelectorAll('.tracking-number, [data-tracking-number]');
        trackingElements.forEach(function(element) {
          element.textContent = formattedNumber;
          if (element.tagName === 'A') {
            element.href = 'tel:' + trackingNumber.replace(/[^\d+]/g, '');
          }
          replacedCount++;
        });
        
        console.log('CallCenter Pro: Replaced', replacedCount, 'phone numbers');
      }
      
      // Make the tracking request
      function requestTrackingNumber() {
        console.log('CallCenter Pro: Requesting tracking number for campaign', CAMPAIGN_ID);
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', TRACKING_SERVER + '/api/dni/track-simple', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var response = JSON.parse(xhr.responseText);
                console.log('CallCenter Pro: Got tracking response:', response);
                if (response.phoneNumber && response.formattedNumber) {
                  replacePhoneNumbers(response.phoneNumber, response.formattedNumber);
                } else {
                  console.error('CallCenter Pro: No phone number in response');
                }
              } catch (e) {
                console.error('CallCenter Pro: Invalid response format', e);
              }
            } else {
              console.error('CallCenter Pro: Tracking request failed with status', xhr.status);
              console.error('CallCenter Pro: Response:', xhr.responseText);
            }
          }
        };
        
        xhr.send(JSON.stringify(trackingData));
      }
      
      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', requestTrackingNumber);
      } else {
        requestTrackingNumber();
      }
      
    })();
    </script>
    
    <!-- OPTION 2: External file approach (if you prefer) -->
    <!-- <script src="http://localhost:5000/external-tracking.js" data-campaign="b14514dc-b985-4790-a6e1-fd2d8db5467e" async></script> -->
    
</body>
</html>