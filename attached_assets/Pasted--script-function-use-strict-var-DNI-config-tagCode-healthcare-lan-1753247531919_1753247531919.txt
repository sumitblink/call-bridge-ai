<script>
(function() {
  'use strict';
  
  var DNI = {
    config: {
      tagCode: 'healthcare_lander',
      apiUrl: 'https://db49e81b-0f19-4f98-81dc-9b5f42c77491-00-229f5d5g77v1k.spock.replit.dev/api/dni/track',
      timeout: 5000,
      captureUserData: true,
      debug: false
    },
    
    init: function() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', this.replaceNumbers.bind(this));
      } else {
        this.replaceNumbers();
      }
    },
    
    replaceNumbers: function() {
      var elements = document.querySelectorAll('.tracking-number, [data-tracking-number]');
      if (elements.length === 0) {
        console.warn('DNI: No tracking number elements found');
        return;
      }
      
      this.getTrackingNumber(function(response) {
        if (response.success && response.formattedNumber) {
          for (var i = 0; i < elements.length; i++) {
            elements[i].textContent = response.formattedNumber;
            // Update href if it's a link
            if (elements[i].tagName === 'A') {
              elements[i].href = 'tel:' + response.phoneNumber;
            }
          }
        }
      });
    },
    
    getTrackingNumber: function(callback) {
      var requestData = {
        tagCode: this.config.tagCode,
        sessionId: this.getSessionId(),
        domain: window.location.hostname,
        referrer: document.referrer,
        userAgent: navigator.userAgent
      };
      
      if (this.config.captureUserData) {
        var urlParams = new URLSearchParams(window.location.search);
        requestData.utmSource = urlParams.get('utm_source');
        requestData.utmMedium = urlParams.get('utm_medium');
        requestData.utmCampaign = urlParams.get('utm_campaign');
        requestData.utmContent = urlParams.get('utm_content');
        requestData.utmTerm = urlParams.get('utm_term');
      }
      
      fetch(this.config.apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData),
        mode: 'cors'
      })
      .then(function(response) {
        return response.json();
      })
      .then(callback)
      .catch(function(error) {
        console.error('DNI Error:', error);
      });
    },
    
    getSessionId: function() {
      var sessionId = sessionStorage.getItem('dni_session_id');
      if (!sessionId) {
        sessionId = 'dni_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('dni_session_id', sessionId);
      }
      return sessionId;
    }
  };
  
  DNI.init();
})();
</script>