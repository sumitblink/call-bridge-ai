<!-- DNI Call Tracking Tag: Healthcare Lander - FIXED VERSION -->
<!-- Replace your phone numbers with this structure -->
<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="https://cy9n0.rdtk.io/track.js?rtkcmpid=6883a9f9969fe3c7bd0bab49"></script>
</head>
<body>

<span class="tracking-number">(555) 123-4567</span>

<!-- Or as a clickable link -->
<a href="tel:+15551234567" class="tracking-number">(555) 123-4567</a>

<!-- FIXED: Updated script with correct endpoint and RedTrack parameters -->
<script>
(function() {
  'use strict';
  
  var DNI = {
    config: {
      campaignId: 'b14514dc-b985-4790-a6e1-fd2d8db5467e', // FIXED: Use campaign ID instead of tag code
      apiUrl: 'https://db49e81b-0f19-4f98-81dc-9b5f42c77491-00-229f5d5g77v1k.spock.replit.dev/api/dni/ultra-fast', // ULTRA-FAST: Sub-50ms endpoint
      timeout: 5000,
      captureUserData: true,
      debug: true // FIXED: Enable debug for console visibility
    },
    
    init: function() {
      console.log('🔥 DNI System Initializing...');
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', this.replaceNumbers.bind(this));
      } else {
        this.replaceNumbers();
      }
    },
    
    replaceNumbers: function() {
      console.log('🔍 Looking for phone number elements...');
      var elements = document.querySelectorAll('.tracking-number, [data-tracking-number]');
      console.log('📞 Found ' + elements.length + ' phone number elements');
      
      if (elements.length === 0) {
        console.log('⚠️ No phone number elements found');
        return;
      }
      
      this.getTrackingNumber(function(response) {
        console.log('📋 API Response:', response);
        if (response.phoneNumber) {
          console.log('✅ Replacing phone numbers with: ' + response.formattedNumber);
          for (var i = 0; i < elements.length; i++) {
            elements[i].textContent = response.formattedNumber;
            // Update href if it's a link
            if (elements[i].tagName === 'A') {
              elements[i].href = 'tel:' + response.phoneNumber;
            }
          }
        } else {
          console.log('❌ No phone number returned from API');
        }
      });
    },
    
    getTrackingNumber: function(callback) {
      var urlParams = new URLSearchParams(window.location.search);
      
      // FIXED: Updated request structure for new endpoint
      var requestData = {
        campaignId: this.config.campaignId, // FIXED: Use campaignId instead of tagCode
        sessionId: this.getSessionId(),
        domain: window.location.hostname,
        referrer: document.referrer,
        userAgent: navigator.userAgent
      };
      
      if (this.config.captureUserData) {
        console.log('🔍 Capturing URL parameters...');
        
        // Standard UTM parameters
        requestData.utmSource = urlParams.get('utm_source');
        requestData.utmMedium = urlParams.get('utm_medium');
        requestData.utmCampaign = urlParams.get('utm_campaign');
        requestData.utmContent = urlParams.get('utm_content');
        requestData.utmTerm = urlParams.get('utm_term');
        
        // FIXED: Added RedTrack sub parameters (sub1-sub8)
        requestData.sub1 = urlParams.get('sub1');
        requestData.sub2 = urlParams.get('sub2');
        requestData.sub3 = urlParams.get('sub3');
        requestData.sub4 = urlParams.get('sub4');
        requestData.sub5 = urlParams.get('sub5');
        requestData.sub6 = urlParams.get('sub6');
        requestData.sub7 = urlParams.get('sub7');
        requestData.sub8 = urlParams.get('sub8');
        
        // RedTrack click ID
        requestData.clickid = urlParams.get('clickid');
        
        // Custom URL parameters (auto-generated from configuration)
        requestData.publisher = urlParams.get('publisher');
        requestData.gclid = urlParams.get('gclid');
        requestData.fbclid = urlParams.get('fbclid');
        requestData.msclkid = urlParams.get('msclkid');
        requestData.ttclid = urlParams.get('ttclid');
        requestData.twclid = urlParams.get('twclid');
        requestData.liclid = urlParams.get('liclid');
        requestData.subid = urlParams.get('subid');
        requestData.affid = urlParams.get('affid');
        requestData.pubid = urlParams.get('pubid');
        requestData.source = urlParams.get('source');
        requestData.medium = urlParams.get('medium');
        requestData.campaign = urlParams.get('campaign');
        requestData.content = urlParams.get('content');
        requestData.term = urlParams.get('term');
        requestData.keyword = urlParams.get('keyword');
        requestData.placement = urlParams.get('placement');
        requestData.adgroup = urlParams.get('adgroup');
        requestData.creative = urlParams.get('creative');
        requestData.device = urlParams.get('device');
        requestData.network = urlParams.get('network');
        requestData.matchtype = urlParams.get('matchtype');
        requestData.adposition = urlParams.get('adposition');
        requestData.target = urlParams.get('target');
        requestData.targetid = urlParams.get('targetid');
        requestData.loc_physical_ms = urlParams.get('loc_physical_ms');
        requestData.loc_interest_ms = urlParams.get('loc_interest_ms');
        
        console.log('📊 Captured URL Data:', {
          utmSource: requestData.utmSource,
          utmMedium: requestData.utmMedium,
          utmCampaign: requestData.utmCampaign,
          clickid: requestData.clickid,
          sub1: requestData.sub1,
          sub2: requestData.sub2,
          sub3: requestData.sub3,
          sub4: requestData.sub4,
          sub5: requestData.sub5,
          sub6: requestData.sub6,
          sub7: requestData.sub7,
          sub8: requestData.sub8,
          publisher: requestData.publisher
        });
      }
      
      console.log('🚀 Sending tracking request:', requestData);
      
      fetch(this.config.apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData),
        mode: 'cors'
      })
      .then(function(response) {
        console.log('📡 Response status:', response.status);
        return response.json();
      })
      .then(function(data) {
        console.log('✅ API Success:', data);
        callback(data);
      })
      .catch(function(error) {
        console.error('❌ API Error:', error);
        callback({ success: false, error: error.message });
      });
    },
    
    getSessionId: function() {
      var sessionId = sessionStorage.getItem('dni_session_id');
      if (!sessionId) {
        sessionId = 'dni_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('dni_session_id', sessionId);
      }
      console.log('🔑 Session ID:', sessionId);
      return sessionId;
    }
  };
  
  DNI.init();
})();
</script>

<!-- Test with RedTrack URL parameters -->
<div style="margin-top: 50px; padding: 20px; background: #f5f5f5; border: 1px solid #ccc;">
  <h3>Test Your RedTrack Integration</h3>
  <p>Click this link to test with sample RedTrack parameters:</p>
  <a href="?sub1=23847616348&sub2=23847614264&sub3=23847614264&sub4=Test%20Ad%20Name&sub5=Test%20Adset%20Name&sub6=Healthcare%20Campaign&sub7=facebook&sub8=facebook.com&utm_source=facebook&utm_medium=paid&utm_campaign=healthcare&clickid=TEST_REDTRACK_CLICKID_999&publisher=TestPublisher" 
     style="color: #007bff; text-decoration: underline; font-weight: bold;">
     🔗 Test RedTrack URL Parameters
  </a>
  <p style="margin-top: 15px; font-size: 12px; color: #666;">
    <strong>Your RedTrack URL Pattern:</strong><br>
    https://cy9n0.rdtk.io/6883a9f9969fe3c7bd0bab49?sub1={{ad.id}}&sub2={{adset.id}}&sub3={{campaign.id}}&sub4={{ad.name}}&sub5={{adset.name}}&sub6={{campaign.name}}&sub7={{placement}}&sub8={{site_source_name}}&utm_source=facebook&utm_medium=paid
  </p>
</div>

</body>
</html>